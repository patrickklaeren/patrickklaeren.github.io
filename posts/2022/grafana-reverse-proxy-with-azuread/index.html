<!doctype html><html lang=en-US class="scroll-smooth dark"><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>patrickk.io | Grafana reverse proxy in IIS with Azure AD</title><meta name=description content="It&rsquo;s 2022, it&rsquo;s been almost a year since the last (and first) post. A lot has happened, including the beginning of the end of the pandemic, and a paradigm shift of telemetry and instrumentation for the software company I work at. I have finally started the transition to introduce Grafana at work - and with that transition, came the upfront cost of expensive trials and tribulations. How do I make this SSL? How do I add Azure AD to Grafana? How do I reverse proxy Grafana with IIS?"><link rel=canonical href=https://patrickk.io/posts/2022/grafana-reverse-proxy-with-azuread/><link rel=robots href=/robots.txt><link rel=icon type=image/x-icon href=/icons/favicon.ico><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><link rel=stylesheet href="https://patrickk.io/css/app.min.2cb70fb9f83d081ead4c74dfa601dd3c78c84840b4c1a660eb0c1c72dd66c3ba.css" integrity="sha256-LLcPufg9CB6tTHTfpgHdPHjISEC0waZg6wwcct1mw7o="></head><body class="max-w-screen-md mx-auto px-2.5"><div class=header><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12"><div class="flex-none w-20 h-20 rounded-full overflow-hidden"><a href=https://patrickk.io/><img srcset="/img/logo_hu_be36e67451a71f56.png 80w" src=/img/logo.png width=1080 height=1080 alt=patrickk.io></a></div><div class="flex flex-col gap-5"><a href=https://patrickk.io/><h1 id=site-title>patrickk.io</h1></a><nav><ul class="flex justify-start"><li><a href=/>Home</a></li><li><a href=/about>About me</a></li></ul></nav></div></header><button class=toggle-theme aria-label="Toggle Theme" title="Toggle Theme" onclick=toggleTheme()>
<span class="theme-icon light"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75.0 11-7.5.0 3.75 3.75.0 017.5.0z"/></svg> </span><span class="theme-icon dark"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718.0 0118 15.75c-5.385.0-9.75-4.365-9.75-9.75.0-1.33.266-2.597.748-3.752A9.753 9.753.0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753.0 009.002-5.998z"/></svg> </span></button>
<script>document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("theme");setTheme(!e||e==="light"?"light":e)});function setTheme(e){const t=document.querySelector("html");localStorage.setItem("theme",e),e==="light"?(t.classList.contains("dark")&&document.querySelector("html").classList.remove("dark"),document.querySelector(".theme-icon.light").style.display="none",document.querySelector(".theme-icon.dark").style.display="block"):(t.classList.contains("dark")||document.querySelector("html").classList.add("dark"),document.querySelector(".theme-icon.dark").style.display="none",document.querySelector(".theme-icon.light").style.display="block")}function toggleTheme(){const e=localStorage.getItem("theme");setTheme(e==="light"?"dark":"light")}</script></div><main id=content><article class="flex flex-col gap-10"><header class="flex flex-col gap-0"><h1>Grafana reverse proxy in IIS with Azure AD</h1><div class=meta><time datetime="2022-02-16 00:00:00 +0000 UTC" title='Wed, Feb 16, 2022, 12:00 AM UTC'>16/02/2022</time></div></header><section><p>It&rsquo;s 2022, it&rsquo;s been almost a year since the last (and first) post. A lot has happened, including the beginning of the end of the pandemic, and a paradigm shift of telemetry and instrumentation for the software company I work at. I have finally started the transition to introduce Grafana at work - and with that transition, came the upfront cost of expensive trials and tribulations. How do I make this SSL? How do I add Azure AD to Grafana? How do I reverse proxy Grafana with IIS?</p><h2 id=my-environment>My environment</h2><p>Before anyone yells at me for not using Linux. We&rsquo;re a .NET shop and a lot, if not all, our applications actively run on Windows-based hosts. This might change in the future. We&rsquo;re not locked to Windows, except for our WPF apps, but we&rsquo;re certainly comfy with Windows and I&rsquo;m more comfortable in a Windows environment than Linux environment. So, here is the environment I&rsquo;m working with:</p><ul><li>Windows Server 2019 (Standard)</li><li>IIS 10</li><li>Grafana (self hosted) 8.3.6</li><li>AzureAD</li><li>Certify The Web 5.6.5</li></ul><p>This assumes a base, vanilla, installation of Grafana situated on <code>localhost:3000</code>. If you have changed your port, adapt these instructions.</p><h2 id=adding-an-iis-reverse-proxy>Adding an IIS Reverse Proxy</h2><p>Outcome: Adding bindings for HTTP(S) traffic on Default Web Site for IIS.</p><ol><li>Launch Certify The Web, create a new managed certifficate for the target Website<ul><li>Before requesting a certificate, under <code>Tasks</code> add a new task to <code>Export Certificate</code>. Under <code>Task Parameters</code>:<ul><li>Keep <code>Authentication</code> as <code>Local</code></li><li>Change destination file path to a file path of your choice, in my case <code>C:\SSL\cert.pem</code></li><li>Change <code>Export As</code> to <code>PEM - Primary Certificate</code></li></ul></li><li>Once you have added this task, repeat the process, this time adding an export certificate task for the <code>PEM - Private Key</code></li></ul></li></ol><p>Your deployment tasks should look like this:</p><p><img src=https://user-images.githubusercontent.com/1341180/154351739-919db611-a68e-4b68-996f-fb5491961b9c.png alt=image></p><ol start=2><li>Request the certificate and verify the bindings have been allocated to the website on IIS</li><li>Install the <a href=https://www.iis.net/downloads/microsoft/url-rewrite>URL Rewrite</a> IIS module</li><li>Install the <a href=https://www.iis.net/downloads/microsoft/application-request-routing>Application Request Routing</a> IIS module</li><li>Open your target website and select the URL rewrite module, clicking <code>Add Rule(s)...</code> on the right hand panel</li></ol><p><img src=https://user-images.githubusercontent.com/1341180/154352228-42d773e1-1771-4b01-847a-7399f27af7b6.png alt=image></p><p><img src=https://user-images.githubusercontent.com/1341180/154352248-553cf789-cdde-4f00-8298-960d6e5fc440.png alt=image></p><ol start=6><li>With the new rule dialog open, in the <code>Inbound Rules</code>, enter <code>https://localhost:3000</code>.</li></ol><h2 id=modifying-grafana-config-for-ssl>Modifying Grafana config for SSL</h2><p>When we are going to add AzureAD OAuth, we need a <code>https</code> redirect - unfortunately, we cannot tell Grafana to blindly run on https, it requires a valid certificate to do so. Leaving it empty will cause Grafana to (gracefully?) crash at startup.</p><p>Go to the Grafana configuration ini, for my Windows Server installation, that&rsquo;s at <code>C:\Program Files\GrafanaLabs\grafana\conf</code>. Ensure you edit <code>sample.ini</code> or any renamed variant of this. I have called my <code>custom.ini</code>. <strong>Do not edit the defaults.ini file if you can help it.</strong></p><ol><li>Stop <code>Grafana</code> service, if it&rsquo;s running</li><li>Open the <code>ini</code> configuration file</li><li>Find the <code>[server]</code> section</li><li>Uncomment and change <code>protocol</code> to <code>protocol = https</code></li><li>Uncomment and change <code>domain</code> to your desired domain, i.e. <code>domain = grafana.contoso.com</code></li><li>Uncomment and change <code>root_url</code> to <code>root_url = %(protocol)s://%(domain)s/</code>, the important note here is we&rsquo;re removing the port</li><li>Uncomment and change <code>cert_file</code> to <code>cert_file = C:\SSL\cert.pem</code> or the location of your certificate file, as exported in Certify The Web&rsquo;s manager</li><li>Uncomment and change <code>cert_key</code> to <code>cert_key = C:\SSL\key.pem</code> or the location of your certificate&rsquo;s key file, as export in Certify The Web&rsquo;s manager</li><li>Start <code>Grafana</code> service and verify it is reachable via your domain</li></ol><p>Because IIS will be running on 443. We cannot run Grafana on 443 by default, it will continue to run on 3000. By changing the <code>root_url</code> configuration, we&rsquo;re forcing Grafana to act as though it&rsquo;s directly hosted on 443, rather than behind a reverse proxy.</p><p>The disadvantage to this is that you will no longer be able to access Grafana via <code>localhost</code>, if that&rsquo;s a requirement, unless you are willing to accept the &ldquo;&ldquo;untrusted&rdquo;&rdquo; certificate. I say &ldquo;&ldquo;untrusted&rdquo;&rdquo; because it was generated by us, for the target domain.</p><h2 id=adding-azure-ad-to-grafana>Adding Azure AD to Grafana</h2><p>This is mostly a <a href=https://grafana.com/docs/grafana/latest/auth/azuread/>documented process on the official Grafana documentation</a>, which is great. Assuming you have followed these steps, modified the config further to include AzureAD and restarted your Grafana service, you will now see a Log in with Microsoft button, using your AzureAD tenant.</p><p>The redirect URL should work, and your reverse proxy is none the wiser.</p><p>This process was mostly trial and error. It is not perfect by any means and I will be revisit it once we have to migrate servers/versions, but it does get AzureAD working in Grafana on self deployed environments. At least in Windows.</p></section><footer></footer></article></main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2"><div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">Â© 2025 -
<a href=https://patrickk.io/>patrickk.io</a></div><div class="order-1 sm:order-2"><ul class="flex sm:justify-end gap-5"><li><a href=https://github.com/patrickklaeren target=_blank rel="me noopener noreferrer">GitHub</a></li></ul></div></footer></body></html>